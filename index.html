<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Precision Tool to Customize Lesson Sequence</title>
<style>
  :root{ --ink:#1e293b; --muted:#64748b; --line:#e5e7eb; --bg:#f8fafc; --brand:#0ea5e9; }
  *{ box-sizing: border-box; }
  body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink); background:var(--bg); margin:0; }
  .wrap{ max-width:1100px; margin:40px auto; padding:0 16px; }
  h1{ margin:0 0 16px 0; font-size:28px; }
  .card{ background:white; border:1px solid var(--line); border-radius:14px; padding:18px; margin:14px 0; }
  .section-title{ font-weight:700; font-size:18px; margin:6px 0 16px; padding:6px 0; border-bottom:2px solid var(--line); }
  .grid{ display:grid; grid-template-columns: 280px 1fr; gap:10px 14px; }
  label{ display:flex; align-items:center; font-weight:600; color:var(--muted); }
  input[type="text"],input[type="date"],select{ width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; }
  .row{ display:flex; gap:10px; align-items:center; }
  .muted{ color:var(--muted); font-size:12px; }
  .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
  button{ padding:10px 14px; border-radius:10px; border:1px solid var(--line); background:#fff; cursor:pointer; }
  .primary{ background:var(--brand); color:white; border-color:var(--brand); }
  table{ width:100%; border-collapse: collapse; }
  th, td{ border-bottom:1px solid var(--line); padding:10px; text-align:left; vertical-align: top; }
  th{ background:#f3f4f6; position:sticky; top:0; z-index:1; }
  .pill{ background:#f1f5f9; border:1px solid var(--line); border-radius:999px; padding:2px 8px; font-size:12px; }
  .warn{ color:#b91c1c; font-weight:600; }
  .two-col{ display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:10px; }
  .checkboxes{ display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:6px 14px; }
  .sr{ position:absolute; left:-9999px; }
</style>
</head>
<body>
<div class="wrap">
  <h1>Precision Tool to Customize Lesson Sequence</h1>

  <!-- Planning Information -->
  <div class="card">
    <div class="section-title">Family Spirit Affiliate Planning Information</div>
    <div class="grid">
      <label for="pid">Participant ID:</label>
      <input id="pid" type="text" placeholder="(optional)">

      <label for="firstLesson">Date of First Lesson:</label>
      <input id="firstLesson" type="date" required>

      <label for="pacing">Pacing:</label>
      <select id="pacing">
        <option value="standard" selected>Standard</option>
        <option value="defined">Defined</option>
      </select>

      <label for="definedPref">If Defined Pacing, Preference:</label>
      <select id="definedPref" disabled>
        <option value="">— select —</option>
        <option value="weekly">Weekly</option>
        <option value="biweekly">Every 2 weeks</option>
        <option value="monthly">Monthly</option>
        <option value="bimonthly">Every 2 months</option>
      </select>
    </div>
  </div>

  <!-- Participant Information -->
  <div class="card">
    <div class="section-title">Participant Information</div>
    <div class="grid">
      <label for="ftp">Is the participant a first time parent?</label>
      <select id="ftp">
        <option value="no">No</option>
        <option value="yes">Yes</option>
      </select>

      <label for="pregnant">Is the participant pregnant?</label>
      <select id="pregnant">
        <option value="no">No</option>
        <option value="yes">Yes</option>
      </select>
    </div>
  </div>

  <!-- Child Information -->
  <div class="card">
    <div class="section-title">Child Information</div>
    <div class="grid">
      <label>Age of youngest child:</label>
      <div id="ageLabel" class="pill">—</div>

      <label for="birthDate">Birth date of youngest child:</label>
      <input id="birthDate" type="date">

      <label for="anticipatedBirth">If prenatal, input anticipated birthdate of youngest child.</label>
      <input id="anticipatedBirth" type="date">
    </div>
    <div class="muted" style="margin-top:8px;">
      Tip: If the participant is pregnant, use <b>Anticipated birthdate</b>. Otherwise use <b>Birth date</b>.
    </div>
  </div>

  <!-- Topics -->
  <div class="card">
    <div class="section-title">Topics of Interest to Family</div>
    <div class="checkboxes">
      <label><input type="checkbox" id="topic_cfw"> Caregiver &amp; Family Wellbeing</label>
      <label><input type="checkbox" id="topic_fp"> Family Planning</label>
      <label><input type="checkbox" id="topic_nutrition"> Nutrition</label>
      <label><input type="checkbox" id="topic_sti"> Sexually Transmitted Infections</label>
      <label><input type="checkbox" id="topic_substance"> Substance Use</label>
    </div>

    <div class="btns">
      <button class="primary" id="generateBtn">Generate Schedule</button>
      <button id="exportBtn" disabled>Export CSV</button>
      <span id="status" class="muted"></span>
    </div>
  </div>

  <!-- Results -->
  <div class="card" id="resultsCard" style="display:none;">
    <div class="section-title">Generated Schedule</div>
    <div id="summary" class="muted" style="margin-bottom:8px;"></div>
    <div style="max-height:60vh; overflow:auto; border:1px solid var(--line); border-radius:10px;">
      <table id="scheduleTable">
        <thead>
          <tr>
            <th>Visit #</th>
            <th>Visit Date</th>
            <th>Child Age (months)</th>
            <th>Lesson Code</th>
            <th>Lesson Subject</th>
            <th>Minutes</th>
            <th>Total per Visit</th>
          </tr>
        </thead>
        <tbody id="scheduleBody"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
/* ---------------------- Utilities ---------------------- */
function parseDate(v){ return v ? new Date(v+"T12:00:00") : null; } // avoid TZ shift
function fmtDate(d){ return d.toLocaleDateString(); }
function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
function monthsBetween(birth, date){
  let m = (date.getFullYear()-birth.getFullYear())*12 + (date.getMonth()-birth.getMonth());
  if (date.getDate() < birth.getDate()) m--;
  return m;
}
function download(filename, text){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([text],{type:'text/plain'}));
  a.download=filename; a.click(); URL.revokeObjectURL(a.href);
}

/* ---------------- Form dynamics ---------------- */
const pacingEl = document.getElementById('pacing');
const definedEl = document.getElementById('definedPref');
pacingEl.addEventListener('change', () => {
  definedEl.disabled = pacingEl.value !== 'defined';
});

const birthEl = document.getElementById('birthDate');
const pregEl = document.getElementById('pregnant');
const anticipatedEl = document.getElementById('anticipatedBirth');
const ageLabel = document.getElementById('ageLabel');
function updateAgeLabel(){
  const isPreg = pregEl.value === 'yes';
  const birth = parseDate(isPreg ? anticipatedEl.value : birthEl.value);
  if(!birth){ ageLabel.textContent = '—'; return; }
  const today = new Date();
  const m = monthsBetween(birth, today);
  ageLabel.textContent = (m < 0) ? 'Prenatal' : `${m} months`;
}
[pregEl, birthEl, anticipatedEl].forEach(el => el.addEventListener('change', updateAgeLabel));
updateAgeLabel();

/* --------------- Core scheduling logic --------------- */

// 1) Generate visits from pacing
function generateVisits(pacing, definedPref, birth, first){
  const end = new Date(birth); end.setMonth(end.getMonth()+36);
  const visits = [];
  let cur = new Date(first);
  const stepFor = (date) => {
    if (pacing === 'defined'){
      return definedPref === 'weekly' ? 7
           : definedPref === 'biweekly' ? 14
           : definedPref === 'monthly' ? 30
           : definedPref === 'bimonthly' ? 60
           : 30;
    } else {
      // Standard schedule (weekly to 3m, biweekly to 7m, monthly to 22m, bimonthly to 36m)
      if (date <= addDays(birth, 90)) return 7;          // to 3 months
      if (date <= addDays(birth, 210)) return 14;        // to 7 months
      if (date <= addDays(birth, 670)) return 30;        // to ~22 months
      return 60;                                         // to 36 months
    }
  };

  // start at first; keep adding until end
  while (cur <= end){
    visits.push(new Date(cur));
    const step = stepFor(cur);
    cur = addDays(cur, step);
  }
  return visits;
}

// 2) Filter lessons by flags + topics; sort by seqAge
function filterLessons(all, sel){
  return all.filter(L=>{
    const passFoundation = !L.foundation || true; // foundation lessons allowed for all
    const passFTP = !L.firstTimeParent || sel.isFTP;
    const passPreg = !L.pregnant || sel.isPregnant;
    const passTopic =
      (!sel.topics.cfw && !L.caregiverWellbeing ? true : sel.topics.cfw || !L.caregiverWellbeing) &&
      (!sel.topics.fp && !L.familyPlanning ? true : sel.topics.fp || !L.familyPlanning) &&
      (!sel.topics.nutrition && !L.nutrition ? true : sel.topics.nutrition || !L.nutrition) &&
      (!sel.topics.sti && !L.sti ? true : sel.topics.sti || !L.sti) &&
      (!sel.topics.substance && !L.substanceUse ? true : sel.topics.substance || !L.substanceUse);
    return passFoundation && passFTP && passPreg && passTopic;
  }).sort((a,b)=> (a.seqAge ?? 999) - (b.seqAge ?? 999));
}

// 3) Assign lessons to visits (≤120 min, ≤3 lessons, respect age window when possible)
function assignLessons(visits, birth, lessons){
  const rows = [];
  let li = 0; // lesson pointer
  for (let v = 0; v < visits.length && li < lessons.length; v++){
    const day = visits[v];
    const ageM = monthsBetween(birth, day);
    let total = 0, count = 0;

    // try to place up to 3 lessons that fit ≤120min and age window
    while (li < lessons.length && count < 3){
      const L = lessons[li];

      const withinAge = (L.seqAge == null || L.seqAge <= ageM) &&
                        (L.upToAge == null || ageM <= L.upToAge);
      const fitsTime  = (total + L.minutes) <= 120;

      if (withinAge && fitsTime){
        rows.push({
          visit: v+1,
          date: day,
          ageM,
          code: L.code,
          subject: L.subject,
          minutes: L.minutes
        });
        total += L.minutes;
        count += 1;
        li++; // consume lesson
      } else {
        // If it doesn't fit this visit, try the next visit (do not consume)
        break;
      }
    }

    // if nothing was placed but a single lesson is >120, place it alone and move on
    if (count === 0 && li < lessons.length && lessons[li].minutes > 120){
      const L = lessons[li];
      rows.push({ visit:v+1, date:day, ageM, code:L.code, subject:L.subject, minutes:L.minutes });
      li++;
    }
  }
  return rows;
}

/* --------------- UI wiring --------------- */

async function getLessons(){
  const res = await fetch('lessons.json');
  if(!res.ok) throw new Error('Could not load lessons.json');
  return res.json();
}

function readSelections(){
  const isFTP = document.getElementById('ftp').value === 'yes';
  const isPregnant = document.getElementById('pregnant').value === 'yes';

  const birth = parseDate(isPregnant ? anticipatedEl.value : birthEl.value);
  const first = parseDate(document.getElementById('firstLesson').value);

  return {
    pid: document.getElementById('pid').value.trim(),
    pacing: document.getElementById('pacing').value,
    definedPref: document.getElementById('definedPref').value || null,
    isFTP, isPregnant,
    birth, first,
    topics: {
      cfw: document.getElementById('topic_cfw').checked,
      fp: document.getElementById('topic_fp').checked,
      nutrition: document.getElementById('topic_nutrition').checked,
      sti: document.getElementById('topic_sti').checked,
      substance: document.getElementById('topic_substance').checked
    }
  };
}

function renderTable(rows){
  const body = document.getElementById('scheduleBody');
  body.innerHTML = '';
  let currentVisit = null, visitTotal = 0;

  rows.forEach((r, idx) => {
    const tr = document.createElement('tr');

    // compute per-visit total by looking ahead to next visit change
    // (we render running total at the last row of that visit)
    const isLastOfVisit = (idx === rows.length-1) || (rows[idx+1].visit !== r.visit);

    // accumulate
    visitTotal = (currentVisit === r.visit) ? visitTotal + r.minutes : r.minutes;
    currentVisit = r.visit;

    const tdVisit = document.createElement('td'); tdVisit.textContent = r.visit;
    const tdDate  = document.createElement('td'); tdDate.textContent = fmtDate(r.date);
    const tdAge   = document.createElement('td'); tdAge.textContent = r.ageM < 0 ? 'Prenatal' : r.ageM;
    const tdCode  = document.createElement('td'); tdCode.textContent = r.code;
    const tdSubj  = document.createElement('td'); tdSubj.textContent = r.subject;
    const tdMin   = document.createElement('td'); tdMin.textContent = r.minutes;
    const tdTotal = document.createElement('td'); tdTotal.textContent = isLastOfVisit ? visitTotal : '';

    tr.append(tdVisit, tdDate, tdAge, tdCode, tdSubj, tdMin, tdTotal);
    body.appendChild(tr);

    if (isLastOfVisit) visitTotal = 0; // reset for next visit
  });

  document.getElementById('resultsCard').style.display = rows.length ? 'block' : 'none';
}

function exportCSV(rows){
  const header = ['Participant ID','Visit #','Visit Date','Child Age (months)','Lesson Code','Lesson Subject','Minutes'];
  const pid = document.getElementById('pid').value.trim();
  const lines = [header.join(',')];
  rows.forEach(r=>{
    const age = r.ageM < 0 ? 'Prenatal' : r.ageM;
    lines.push([pid, r.visit, fmtDate(r.date), age, r.code, `"${r.subject.replace(/"/g,'""')}"`, r.minutes].join(','));
  });
  download('schedule.csv', lines.join('\n'));
}

/* --------------- Generate button --------------- */
document.getElementById('generateBtn').addEventListener('click', async ()=> {
  try{
    const sel = readSelections();
    const status = document.getElementById('status');
    if(!sel.first || !sel.birth){
      status.textContent = 'Please fill First Lesson Date and Birth/Anticipated Birth.';
      return;
    }
    status.textContent = 'Building schedule…';

    const allLessons = await getLessons();
    const visits = generateVisits(sel.pacing, sel.definedPref, sel.birth, sel.first);
    const queue  = filterLessons(allLessons, sel);
    const rows   = assignLessons(visits, sel.birth, queue);

    renderTable(rows);

    document.getElementById('summary').textContent =
      `${rows.length ? 'Generated ' + rows.length + ' lesson rows.' : 'No lessons placed.'} ` +
      `(Visits created: ${visits.length}).`;
    document.getElementById('exportBtn').disabled = rows.length === 0;
    document.getElementById('exportBtn').onclick = () => exportCSV(rows);
    status.textContent = '';
  }catch(err){
    console.error(err);
    document.getElementById('status').textContent = 'Error: ' + err.message;
  }
});
</script>
</body>
</html>
